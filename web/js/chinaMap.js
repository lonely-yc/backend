/**
 * 中国地图数据 - ECharts GeoJSON
 * 简化的中国地图，包含主要省份边界
 */

const ChinaMapData = {
  type: "FeatureCollection",
  features: [
    {
      type: "Feature",
      properties: { name: "广东", adcode: 440000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[113.8, 20.4], [114.5, 20.3], [115.5, 20.9], [116.5, 22.5], [116.9, 23.1], [116.0, 23.5], [114.5, 23.5], [113.6, 22.9], [113.0, 22.5], [113.0, 21.5], [113.8, 20.4]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "浙江", adcode: 330000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[120.0, 27.5], [121.5, 27.8], [122.0, 29.0], [122.0, 30.5], [121.0, 30.8], [120.2, 31.0], [119.5, 30.5], [119.0, 29.0], [120.0, 27.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "江苏", adcode: 320000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[118.5, 31.0], [119.0, 31.5], [121.0, 31.8], [121.5, 32.0], [121.0, 33.0], [120.2, 33.5], [119.5, 33.8], [118.5, 33.5], [118.0, 32.5], [118.5, 31.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "山东", adcode: 370000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[115.5, 35.0], [118.0, 35.0], [122.0, 35.0], [122.5, 37.0], [122.0, 38.0], [120.0, 38.0], [118.5, 37.5], [118.0, 36.0], [115.5, 36.0], [115.5, 35.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "福建", adcode: 350000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[117.0, 23.5], [118.5, 23.5], [120.0, 25.0], [120.3, 26.5], [119.5, 27.5], [118.0, 27.5], [116.5, 26.0], [117.0, 23.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "上海", adcode: 310000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[121.0, 30.7], [121.5, 31.0], [121.8, 31.5], [121.5, 31.8], [121.0, 31.5], [120.8, 31.0], [121.0, 30.7]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "北京", adcode: 110000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[116.0, 39.5], [117.0, 39.5], [117.0, 40.5], [116.5, 41.0], [116.0, 40.5], [115.5, 40.0], [116.0, 39.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "天津", adcode: 120000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[116.5, 38.5], [118.0, 38.5], [118.0, 39.5], [117.5, 39.5], [116.5, 39.5], [116.5, 38.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "河北", adcode: 130000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[114.0, 36.5], [115.5, 36.5], [117.0, 38.0], [118.0, 39.0], [117.0, 40.0], [115.0, 40.0], [114.0, 39.5], [114.0, 38.0], [114.0, 36.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "河南", adcode: 410000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[110.5, 33.0], [112.0, 33.0], [114.0, 34.0], [116.0, 35.0], [115.5, 36.0], [114.0, 36.0], [112.0, 35.0], [110.5, 34.0], [110.5, 33.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "湖北", adcode: 420000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[108.5, 29.0], [110.0, 30.0], [112.0, 31.0], [114.5, 31.0], [115.0, 30.0], [114.0, 29.0], [112.0, 29.0], [110.0, 29.5], [108.5, 29.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "湖南", adcode: 430000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[108.5, 24.5], [110.0, 25.5], [111.5, 26.5], [114.0, 27.0], [114.0, 29.0], [113.0, 29.5], [111.0, 29.0], [110.0, 28.5], [108.5, 27.5], [108.5, 24.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "江西", adcode: 360000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[113.5, 24.5], [115.0, 25.0], [116.5, 26.0], [118.0, 28.0], [117.5, 29.0], [116.0, 29.0], [114.5, 28.0], [113.5, 27.0], [113.5, 24.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "安徽", adcode: 340000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[114.5, 29.5], [116.0, 30.0], [117.5, 31.0], [118.5, 32.0], [118.0, 33.0], [117.0, 33.5], [116.0, 33.0], [115.0, 32.0], [114.5, 31.0], [114.5, 29.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "四川", adcode: 510000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[97.0, 26.0], [100.0, 28.0], [102.0, 29.0], [105.0, 28.5], [108.0, 29.0], [110.0, 31.0], [108.5, 32.5], [105.0, 32.5], [102.0, 32.0], [100.0, 30.5], [97.0, 28.0], [97.0, 26.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "重庆", adcode: 500000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[105.5, 28.5], [107.0, 29.0], [108.5, 29.5], [109.5, 30.5], [109.0, 31.5], [108.0, 31.5], [106.5, 31.0], [105.5, 30.0], [105.5, 28.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "陕西", adcode: 610000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[105.5, 31.5], [108.0, 32.0], [110.0, 33.5], [111.0, 35.0], [110.0, 36.5], [108.0, 36.5], [106.5, 35.5], [105.5, 34.0], [105.5, 31.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "山西", adcode: 140000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[110.5, 35.0], [112.0, 35.5], [113.0, 37.0], [112.0, 39.0], [111.0, 39.5], [110.0, 38.5], [110.5, 36.5], [110.5, 35.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "云南", adcode: 530000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[97.0, 21.5], [99.0, 23.0], [101.0, 25.0], [104.0, 25.5], [106.0, 24.5], [105.0, 23.0], [102.0, 22.0], [100.0, 22.5], [97.0, 24.0], [97.0, 21.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "贵州", adcode: 520000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[103.5, 24.5], [105.0, 25.5], [106.5, 26.5], [108.0, 27.5], [108.5, 29.0], [107.0, 29.5], [105.5, 29.0], [104.5, 28.0], [103.5, 26.5], [103.5, 24.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "广西", adcode: 450000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[104.5, 21.5], [106.0, 22.5], [108.0, 23.5], [109.5, 25.0], [111.0, 24.5], [110.5, 23.0], [109.0, 21.5], [107.0, 21.0], [105.0, 22.0], [104.5, 21.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "海南", adcode: 460000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[108.5, 18.5], [110.0, 19.5], [111.0, 20.0], [110.5, 21.0], [109.5, 21.0], [108.0, 20.0], [108.5, 18.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "辽宁", adcode: 210000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[118.5, 39.0], [121.0, 39.0], [123.0, 39.5], [124.5, 40.5], [125.0, 42.0], [123.0, 43.0], [121.0, 42.5], [119.5, 41.5], [118.5, 40.5], [118.5, 39.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "吉林", adcode: 220000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[121.5, 40.5], [124.0, 41.0], [126.0, 42.0], [126.5, 44.0], [125.5, 45.5], [123.5, 45.5], [122.0, 44.5], [121.5, 43.0], [121.5, 40.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "黑龙江", adcode: 230000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[121.5, 43.0], [124.0, 44.0], [127.0, 45.5], [129.5, 47.0], [130.0, 48.5], [128.0, 49.5], [124.0, 49.5], [122.0, 48.5], [121.5, 47.0], [121.5, 45.0], [121.5, 43.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "内蒙古", adcode: 150000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[106.5, 38.5], [110.0, 40.0], [111.0, 42.0], [114.0, 43.0], [117.0, 43.5], [120.0, 42.5], [122.0, 43.5], [123.0, 45.0], [122.0, 46.5], [118.0, 47.5], [111.0, 47.5], [106.5, 45.5], [104.5, 42.5], [106.5, 38.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "宁夏", adcode: 640000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[104.5, 36.5], [106.5, 37.0], [106.5, 39.0], [105.5, 39.5], [104.5, 39.0], [104.5, 36.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "甘肃", adcode: 620000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[92.5, 39.5], [95.0, 40.5], [96.5, 42.0], [98.5, 43.0], [100.0, 42.0], [101.5, 40.0], [103.5, 38.5], [105.0, 37.5], [104.5, 36.5], [102.0, 35.5], [100.0, 36.0], [95.0, 38.5], [92.5, 39.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "青海", adcode: 630000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[89.0, 35.5], [92.0, 36.5], [94.0, 38.0], [96.0, 38.5], [98.0, 37.5], [100.0, 36.0], [99.0, 35.0], [96.0, 35.0], [93.0, 35.5], [89.0, 35.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "西藏", adcode: 540000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[78.0, 32.0], [80.0, 35.0], [82.0, 37.0], [85.0, 39.0], [88.0, 39.5], [91.0, 39.0], [95.0, 37.5], [97.0, 35.0], [96.0, 32.0], [93.0, 29.0], [89.0, 28.0], [85.0, 29.5], [82.0, 31.0], [78.0, 32.0]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "新疆", adcode: 650000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[72.5, 39.5], [75.0, 40.5], [76.5, 42.5], [80.0, 44.0], [83.5, 44.5], [86.5, 44.0], [88.0, 42.5], [90.0, 42.5], [91.5, 41.5], [90.0, 40.0], [86.0, 39.0], [82.0, 40.0], [79.0, 40.5], [75.0, 40.0], [73.0, 39.0], [72.5, 39.5]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "香港", adcode: 810000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[114.0, 22.3], [114.2, 22.4], [114.3, 22.5], [114.2, 22.6], [114.0, 22.5], [114.0, 22.3]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "澳门", adcode: 820000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[113.5, 22.1], [113.55, 22.15], [113.6, 22.15], [113.55, 22.2], [113.5, 22.1]]]
      }
    },
    {
      type: "Feature",
      properties: { name: "台湾", adcode: 710000 },
      geometry: {
        type: "Polygon",
        coordinates: [[[120.5, 21.5], [121.5, 22.0], [122.0, 24.0], [121.5, 25.5], [120.5, 25.5], [120.0, 23.5], [120.5, 21.5]]]
      }
    }
  ]
};

// 省份名称映射（处理简称/别名）
const ProvinceNameMap = {
  '北京': '北京', '北京市': '北京',
  '上海': '上海', '上海市': '上海',
  '天津': '天津', '天津市': '天津',
  '重庆': '重庆', '重庆市': '重庆',
  '广东': '广东', '广东省': '广东', '广州': '广东', '深圳': '广东',
  '浙江': '浙江', '浙江省': '浙江', '杭州': '浙江', '宁波': '浙江',
  '江苏': '江苏', '江苏省': '江苏', '南京': '江苏', '苏州': '江苏',
  '山东': '山东', '山东省': '山东', '济南': '山东', '青岛': '山东',
  '福建': '福建', '福建省': '福建', '福州': '福建', '厦门': '福建',
  '河北': '河北', '河北省': '河北', '石家庄': '河北',
  '河南': '河南', '河南省': '河南', '郑州': '河南', '洛阳': '河南',
  '湖北': '湖北', '湖北省': '湖北', '武汉': '湖北',
  '湖南': '湖南', '湖南省': '湖南', '长沙': '湖南',
  '江西': '江西', '江西省': '江西', '南昌': '江西',
  '安徽': '安徽', '安徽省': '安徽', '合肥': '安徽',
  '四川': '四川', '四川省': '四川', '成都': '四川', '四川': '四川',
  '陕西': '陕西', '陕西省': '陕西', '西安': '陕西',
  '山西': '山西', '山西省': '山西', '太原': '山西',
  '云南': '云南', '云南省': '云南', '昆明': '云南',
  '贵州': '贵州', '贵州省': '贵州', '贵阳': '贵州',
  '广西': '广西', '广西壮族自治区': '广西', '南宁': '广西',
  '海南': '海南', '海南省': '海南', '海口': '海南',
  '辽宁': '辽宁', '辽宁省': '辽宁', '沈阳': '辽宁', '大连': '辽宁',
  '吉林': '吉林', '吉林省': '吉林', '长春': '吉林',
  '黑龙江': '黑龙江', '黑龙江省': '黑龙江', '哈尔滨': '黑龙江',
  '内蒙古': '内蒙古', '内蒙古自治区': '内蒙古', '呼和浩特': '内蒙古',
  '宁夏': '宁夏', '宁夏回族自治区': '宁夏', '银川': '宁夏',
  '甘肃': '甘肃', '甘肃省': '甘肃', '兰州': '甘肃',
  '青海': '青海', '青海省': '青海', '西宁': '青海',
  '西藏': '西藏', '西藏自治区': '西藏', '拉萨': '西藏',
  '新疆': '新疆', '新疆维吾尔自治区': '新疆', '乌鲁木齐': '新疆',
  '香港': '香港', '香港特别行政区': '香港',
  '澳门': '澳门', '澳门特别行政区': '澳门',
  '台湾': '台湾', '台湾省': '台湾', '台北': '台湾',
};

// 籍贯关键词到省份的映射
const PlaceKeywordMap = {
  '京': '北京', '北京': '北京',
  '沪': '上海', '上海': '上海',
  '津': '天津', '天津': '天津',
  '渝': '重庆', '重庆': '重庆',
  '粤': '广东', '广州': '广东', '深圳': '广东', '东莞': '广东', '佛山': '广东',
  '浙': '浙江', '杭州': '浙江', '宁波': '浙江', '温州': '浙江',
  '苏': '江苏', '南京': '江苏', '苏州': '江苏', '无锡': '江苏',
  '鲁': '山东', '济南': '山东', '青岛': '山东', '烟台': '山东',
  '闽': '福建', '福州': '福建', '厦门': '福建', '泉州': '福建',
  '冀': '河北', '石家庄': '河北', '保定': '河北',
  '豫': '河南', '郑州': '河南', '洛阳': '河南', '开封': '河南',
  '鄂': '湖北', '武汉': '湖北', '宜昌': '湖北',
  '湘': '湖南', '长沙': '湖南', '岳阳': '湖南',
  '赣': '江西', '南昌': '江西', '九江': '江西',
  '皖': '安徽', '合肥': '安徽', '芜湖': '安徽',
  '川': '四川', '成都': '四川', '重庆': '重庆', '绵阳': '四川',
  '陕': '陕西', '西安': '陕西', '延安': '陕西',
  '晋': '山西', '太原': '山西', '大同': '山西',
  '云': '云南', '昆明': '云南', '大理': '云南',
  '贵': '贵州', '贵阳': '贵州', '遵义': '贵州',
  '桂': '广西', '南宁': '广西', '桂林': '广西',
  '琼': '海南', '海口': '海南', '三亚': '海南',
  '辽': '辽宁', '沈阳': '辽宁', '大连': '辽宁',
  '吉': '吉林', '长春': '吉林', '吉林': '吉林',
  '黑': '黑龙江', '哈尔滨': '黑龙江', '齐齐哈尔': '黑龙江',
  '蒙': '内蒙古', '呼和浩特': '内蒙古', '包头': '内蒙古',
  '宁': '宁夏', '银川': '宁夏', '石嘴山': '宁夏',
  '甘': '甘肃', '兰州': '甘肃', '敦煌': '甘肃',
  '青': '青海', '西宁': '青海', '格尔木': '青海',
  '藏': '西藏', '拉萨': '西藏', '日喀则': '西藏',
  '新': '新疆', '乌鲁木齐': '新疆', '喀什': '新疆',
  '港': '香港', '澳': '澳门',
};

// 省份省会坐标（用于散点图）
const ProvinceCoords = {
  '北京': [116.46, 39.92],
  '上海': [121.48, 31.22],
  '天津': [117.2, 39.13],
  '重庆': [106.54, 29.59],
  '广东': [113.26, 23.13],
  '浙江': [120.15, 30.27],
  '江苏': [118.78, 32.04],
  '山东': [117.0, 36.65],
  '福建': [119.3, 26.08],
  '河北': [114.48, 38.03],
  '河南': [113.7, 34.76],
  '湖北': [114.31, 30.52],
  '湖南': [112.94, 28.23],
  '江西': [115.89, 28.68],
  '安徽': [117.27, 31.86],
  '四川': [104.06, 30.67],
  '陕西': [108.95, 34.27],
  '山西': [112.55, 37.87],
  '云南': [102.73, 25.04],
  '贵州': [106.71, 26.57],
  '广西': [108.33, 22.84],
  '海南': [110.35, 20.02],
  '辽宁': [123.38, 41.8],
  '吉林': [125.32, 43.89],
  '黑龙江': [126.63, 45.75],
  '内蒙古': [111.77, 40.82],
  '宁夏': [106.23, 38.47],
  '甘肃': [103.73, 36.03],
  '青海': [101.78, 36.62],
  '西藏': [91.11, 29.97],
  '新疆': [87.62, 43.82],
  '香港': [114.17, 22.28],
  '澳门': [113.54, 22.19],
  '台湾': [121.53, 25.03],
};

// 标准化省份名称
function normalizeProvince(place) {
  if (!place) return null;
  place = place.trim();
  if (!place) return null;

  // 1. 直辖市精确匹配（优先级最高）
  const municipalities = ['北京市', '天津市', '上海市', '重庆市'];
  for (const m of municipalities) {
    if (place === m || place === m.replace('市', '') || place === m.replace('市', '') + '市') {
      return m.replace('市', '');
    }
  }

  // 2. 自治区精确匹配
  const autonomousRegions = [
    '内蒙古自治区', '广西壮族自治区', '西藏自治区', '宁夏回族自治区', '新疆维吾尔自治区'
  ];
  for (const r of autonomousRegions) {
    const shortName = r.replace(/自治区|壮族自治区|维吾尔自治区|回族自治区/, '');
    if (place.includes(r) || place.includes(shortName)) {
      return shortName;
    }
  }

  // 3. 省份全称匹配
  const provinces = [
    '广东省', '浙江省', '江苏省', '山东省', '福建省', '河北省', '河南省',
    '湖北省', '湖南省', '江西省', '安徽省', '四川省', '陕西省', '山西省',
    '云南省', '贵州省', '广西壮族自治区', '海南省', '辽宁省', '吉林省',
    '黑龙江省', '青海省', '甘肃省', '台湾省'
  ];
  for (const p of provinces) {
    if (place.includes(p)) {
      return p.replace('省', '');
    }
  }

  // 4. 省会/城市匹配 - 需要更精确，避免误匹配
  const cityToProvince = {
    // 广东
    '广州': '广东', '深圳': '广东', '东莞': '广东', '佛山': '广东', '珠海': '广东',
    '中山': '广东', '惠州': '广东', '江门': '广东', '湛江': '广东', '茂名': '广东',
    '肇庆': '广东', '汕头': '广东', '梅州': '广东', '汕尾': '广东', '河源': '广东',
    '阳江': '广东', '清远': '广东', '韶关': '广东', '揭阳': '广东', '潮州': '广东', '云浮': '广东',
    // 浙江
    '杭州': '浙江', '宁波': '浙江', '温州': '浙江', '绍兴': '浙江', '湖州': '浙江',
    '嘉兴': '浙江', '金华': '浙江', '衢州': '浙江', '舟山': '浙江', '台州': '浙江', '丽水': '浙江',
    // 江苏
    '南京': '江苏', '苏州': '江苏', '无锡': '江苏', '常州': '江苏', '镇江': '江苏',
    '扬州': '江苏', '泰州': '江苏', '南通': '江苏', '盐城': '江苏', '淮安': '江苏',
    '连云港': '江苏', '徐州': '江苏', '宿迁': '江苏',
    // 山东
    '济南': '山东', '青岛': '山东', '烟台': '山东', '威海': '山东', '潍坊': '山东',
    '淄博': '山东', '临沂': '山东', '济宁': '山东', '泰安': '山东', '德州': '山东',
    '滨州': '山东', '东营': '山东', '菏泽': '山东', '聊城': '山东', '枣庄': '山东', '日照': '山东',
    // 福建
    '福州': '福建', '厦门': '福建', '泉州': '福建', '漳州': '福建', '莆田': '福建',
    '宁德': '福建', '三明': '福建', '南平': '福建', '龙岩': '福建',
    // 河北
    '石家庄': '河北', '保定': '河北', '唐山': '河北', '廊坊': '河北', '沧州': '河北',
    '邯郸': '河北', '邢台': '河北', '衡水': '河北', '张家口': '河北', '承德': '河北', '秦皇岛': '河北',
    // 河南
    '郑州': '河南', '洛阳': '河南', '开封': '河南', '南阳': '河南', '新乡': '河南',
    '安阳': '河南', '焦作': '河南', '许昌': '河南', '平顶山': '河南', '商丘': '河南',
    '周口': '河南', '信阳': '河南', '驻马店': '河南', '濮阳': '河南', '三门峡': '河南',
    '漯河': '河南', '鹤壁': '河南', '济源': '河南',
    // 湖北
    '武汉': '湖北', '宜昌': '湖北', '襄阳': '湖北', '荆州': '湖北', '荆门': '湖北',
    '黄冈': '湖北', '孝感': '湖北', '咸宁': '湖北', '十堰': '湖北', '随州': '湖北',
    '鄂州': '湖北', '恩施': '湖北', '仙桃': '湖北', '潜江': '湖北', '天门': '湖北', '神农架': '湖北',
    // 湖南
    '长沙': '湖南', '岳阳': '湖南', '株洲': '湖南', '湘潭': '湖南', '衡阳': '湖南',
    '邵阳': '湖南', '常德': '湖南', '张家界': '湖南', '益阳': '湖南', '郴州': '湖南',
    '永州': '湖南', '怀化': '湖南', '娄底': '湖南', '湘西': '湖南',
    // 江西
    '南昌': '江西', '九江': '江西', '赣州': '江西', '吉安': '江西', '宜春': '江西',
    '抚州': '江西', '上饶': '江西', '景德镇': '江西', '萍乡': '江西', '新余': '江西', '鹰潭': '江西',
    // 安徽
    '合肥': '安徽', '芜湖': '安徽', '蚌埠': '安徽', '淮南': '安徽', '马鞍山': '安徽',
    '淮北': '安徽', '铜陵': '安徽', '安庆': '安徽', '黄山': '安徽', '滁州': '安徽',
    '阜阳': '安徽', '宿州': '安徽', '六安': '安徽', '亳州': '安徽', '池州': '安徽', '宣城': '安徽',
    // 四川
    '成都': '四川', '绵阳': '四川', '德阳': '四川', '宜宾': '四川', '南充': '四川',
    '泸州': '四川', '乐山': '四川', '内江': '四川', '自贡': '四川', '攀枝花': '四川',
    '广元': '四川', '遂宁': '四川', '广安': '四川', '达州': '四川', '雅安': '四川',
    '巴中': '四川', '眉山': '四川', '资阳': '四川', '凉山': '四川', '甘孜': '四川', '阿坝': '四川',
    // 陕西
    '西安': '陕西', '宝鸡': '陕西', '咸阳': '陕西', '渭南': '陕西', '铜川': '陕西',
    '延安': '陕西', '榆林': '陕西', '汉中': '陕西', '安康': '陕西', '商洛': '陕西',
    // 山西
    '太原': '山西', '大同': '山西', '阳泉': '山西', '长治': '山西', '晋城': '山西',
    '朔州': '山西', '晋中': '山西', '运城': '山西', '忻州': '山西', '临汾': '山西', '吕梁': '山西',
    // 云南
    '昆明': '云南', '曲靖': '云南', '玉溪': '云南', '保山': '云南', '昭通': '云南',
    '丽江': '云南', '普洱': '云南', '临沧': '云南', '楚雄': '云南', '红河': '云南',
    '文山': '云南', '西双版纳': '云南', '大理': '云南', '德宏': '云南', '怒江': '云南', '迪庆': '云南',
    // 贵州
    '贵阳': '贵州', '遵义': '贵州', '六盘水': '贵州', '安顺': '贵州', '毕节': '贵州',
    '铜仁': '贵州', '黔西南': '贵州', '黔东南': '贵州', '黔南': '贵州',
    // 辽宁
    '沈阳': '辽宁', '大连': '辽宁', '鞍山': '辽宁', '抚顺': '辽宁', '本溪': '辽宁',
    '丹东': '辽宁', '锦州': '辽宁', '营口': '辽宁', '阜新': '辽宁', '辽阳': '辽宁',
    '盘锦': '辽宁', '铁岭': '辽宁', '朝阳': '辽宁', '葫芦岛': '辽宁',
    // 吉林
    '长春': '吉林', '吉林': '吉林', '四平': '吉林', '辽源': '吉林', '通化': '吉林',
    '白山': '吉林', '松原': '吉林', '白城': '吉林', '延边': '吉林',
    // 黑龙江
    '哈尔滨': '黑龙江', '齐齐哈尔': '黑龙江', '鸡西': '黑龙江', '鹤岗': '黑龙江', '双鸭山': '黑龙江',
    '大庆': '黑龙江', '伊春': '黑龙江', '佳木斯': '黑龙江', '七台河': '黑龙江', '牡丹江': '黑龙江',
    '黑河': '黑龙江', '绥化': '黑龙江', '大兴安岭': '黑龙江',
    // 广西
    '南宁': '广西', '柳州': '广西', '桂林': '广西', '梧州': '广西', '北海': '广西',
    '防城港': '广西', '钦州': '广西', '贵港': '广西', '玉林': '广西', '百色': '广西',
    '贺州': '广西', '河池': '广西', '来宾': '广西', '崇左': '广西',
    // 海南
    '海口': '海南', '三亚': '海南', '三沙': '海南', '儋州': '海南',
    // 青海
    '西宁': '青海', '海东': '青海', '海北': '青海', '黄南': '青海', '海南': '青海',
    '果洛': '青海', '玉树': '青海', '海西': '青海',
    // 甘肃
    '兰州': '甘肃', '嘉峪关': '甘肃', '金昌': '甘肃', '白银': '甘肃', '天水': '甘肃',
    '武威': '甘肃', '张掖': '甘肃', '平凉': '甘肃', '酒泉': '甘肃', '庆阳': '甘肃',
    '定西': '甘肃', '陇南': '甘肃', '临夏': '甘肃', '甘南': '甘肃',
    // 宁夏
    '银川': '宁夏', '石嘴山': '宁夏', '吴忠': '宁夏', '固原': '宁夏', '中卫': '宁夏',
    // 新疆
    '乌鲁木齐': '新疆', '克拉玛依': '新疆', '吐鲁番': '新疆', '哈密': '新疆', '昌吉': '新疆',
    '博尔塔拉': '新疆', '巴音郭楞': '新疆', '阿克苏': '新疆', '克孜勒苏': '新疆', '喀什': '新疆',
    '和田': '新疆', '伊犁': '新疆', '塔城': '新疆', '阿勒泰': '新疆',
    // 内蒙古
    '呼和浩特': '内蒙古', '包头': '内蒙古', '乌海': '内蒙古', '赤峰': '内蒙古', '通辽': '内蒙古',
    '鄂尔多斯': '内蒙古', '呼伦贝尔': '内蒙古', '巴彦淖尔': '内蒙古', '乌兰察布': '内蒙古',
    '兴安': '内蒙古', '锡林郭勒': '内蒙古', '阿拉善': '内蒙古',
    // 西藏
    '拉萨': '西藏', '日喀则': '西藏', '昌都': '西藏', '林芝': '西藏', '山南': '西藏',
    '那曲': '西藏', '阿里': '西藏',
    // 港澳台
    '香港': '香港', '澳门': '澳门', '台北': '台湾', '高雄': '台湾', '台中': '台湾',
  };

  // 城市精确匹配（避免包含关系误匹配）
  for (const [city, province] of Object.entries(cityToProvince)) {
    if (place === city || place.includes(city + '市') || place.includes(city + '区') ||
        place.includes(province + city) || place.endsWith(city)) {
      return province;
    }
  }

  // 5. 车牌号简称匹配（放在最后，因为容易误匹配）
  const plateAbbr = {
    '京': '北京', '沪': '上海', '津': '天津', '渝': '重庆',
    '粤': '广东', '浙': '浙江', '苏': '江苏', '鲁': '山东',
    '闽': '福建', '冀': '河北', '豫': '河南', '鄂': '湖北',
    '湘': '湖南', '赣': '江西', '皖': '安徽', '川': '四川',
    '陕': '陕西', '晋': '山西', '云': '云南', '贵': '贵州',
    '桂': '广西', '琼': '海南', '辽': '辽宁', '吉': '吉林',
    '黑': '黑龙江', '蒙': '内蒙古', '宁': '宁夏', '甘': '甘肃',
    '青': '青海', '藏': '西藏', '新': '新疆',
  };

  // 车牌号匹配需要确保是单独的字符
  for (const [abbr, province] of Object.entries(plateAbbr)) {
    // 检查是否是独立的车牌号格式
    if (place === abbr || place === abbr + '牌' || place === '车牌' + abbr ||
        (place.length <= 3 && place.includes(abbr))) {
      return province;
    }
  }

  return null;
}

// 统计籍贯分布
function countBirthPlace(persons) {
  const countMap = {};
  const unmatched = [];

  persons.forEach(p => {
    const province = normalizeProvince(p.birthPlace);
    if (province) {
      countMap[province] = (countMap[province] || 0) + 1;
    } else if (p.birthPlace && p.birthPlace.trim()) {
      unmatched.push(p.birthPlace);
    }
  });

  return { countMap, unmatched };
}

// 转换为 ECharts 散点数据
function getMapScatterData(persons) {
  const { countMap } = countBirthPlace(persons);
  return Object.entries(countMap).map(([name, value]) => {
    const coords = ProvinceCoords[name] || [116.46, 39.92];
    return {
      name,
      value: [...coords, value],
    };
  });
}
